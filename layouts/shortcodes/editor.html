<style>
    .editor-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        font-family: system-ui, -apple-system, sans-serif;
    }
    .editor-textarea {
        width: 100%;
        min-height: 100px;
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: inherit;
        resize: vertical;
    }
    .editor-button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.2s;
    }
    .editor-button:hover {
        background-color: #0056b3;
    }
    .editor-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    .editor-response {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #f9f9f9;
        display: none;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    .editor-error {
        color: #dc3545;
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        background-color: #ffe6e6;
        display: none;
    }
    .editor-loading {
        display: none;
        margin-top: 10px;
        color: #666;
        text-align: center;
    }
    .editor-controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    .json-key {
        color: #0451a5;
    }
    .json-string {
        color: #a31515;
    }
    .json-number {
        color: #098658;
    }
    .json-boolean {
        color: #0000ff;
    }
    .json-null {
        color: #808080;
    }
    .response-container {
        position: relative;
        margin-top: 20px;
    }
    .editor-response {
        margin-top: 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #f9f9f9;
        display: none;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        position: relative;
    }
</style>

<div class="editor-container">
    <textarea 
        id="editorInput" 
        class="editor-textarea" 
        placeholder="Enter your text here..."
    ></textarea>
    <div class="editor-controls">
        <button 
            onclick="sendToOpenAI()" 
            id="editorSubmit" 
            class="editor-button"
        >
            Convert to Open Syndrome Format
        </button>
        <button 
            onclick="clearEditor()" 
            id="editorClear" 
            class="editor-button"
            style="background-color: #6c757d;"
        >
            Clear
        </button>
    </div>
    <div id="editorLoading" class="editor-loading">
        Processing your request...
    </div>
    <div class="response-container">
        <div id="editorResponse" class="editor-response"></div>
    </div>
    <div id="editorError" class="editor-error"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
<script>
    function syntaxHighlight(json) {
        if (typeof json !== 'string') {
            json = JSON.stringify(json, null, 2);
        }
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            let cls = 'json-number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'json-key';
                } else {
                    cls = 'json-string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'json-boolean';
            } else if (/null/.test(match)) {
                cls = 'json-null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            const copyButton = document.getElementById('copyButton');
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
                copyButton.textContent = 'Copy';
            }, 2000);
        });
    }

    async function sendToOpenAI() {
        const userInput = document.getElementById('editorInput').value;
        const submitBtn = document.getElementById('editorSubmit');
        const loading = document.getElementById('editorLoading');
        const responseDiv = document.getElementById('editorResponse');
        const errorDiv = document.getElementById('editorError');

        if (!userInput.trim()) {
            errorDiv.textContent = 'Please enter some text';
            errorDiv.style.display = 'block';
            return;
        }

        submitBtn.disabled = true;
        loading.style.display = 'block';
        responseDiv.style.display = 'none';
        errorDiv.style.display = 'none';

        try {
            // TODO to be enabled with Netlify
            /*const response = await axios.post('/api/openai', {
                prompt: userInput
            });*/
            // FIXME hardcoded JSON
            const hardCodedSyndrome = {
            "title": "Acute Diarrhea Case Definition",
            "description": "Standardized case definition for acute diarrhea as an Adverse Event Following Immunization (AEFI) to enable consistent reporting and comparison across different healthcare settings and surveillance systems",
            "scope": "specific",
            "version": "1.0.0",
            "open_syndrome_version": 1.0,
            "publish_in": "https://brightoncollaboration.org/diarrhea",
            "published_at": "2024-10-25 00:00:00.000000",
            "location": "Global",
            "organization": "Brighton Collaboration",
            "language": "en",
            "authors": ["Brighton Collaboration Diarrhea Working Group"],
            "clinical_criterias": [
                {
                    "type": "criteria",
                    "logical_operator": "AND",
                    "values": [
                        {
                            "type": "symptom",
                            "name": "loose_stool"
                        },
                        {
                            "type": "value",
                            "name": "stool_frequency",
                            "operator": ">=",
                            "value": "3"
                        },
                        {
                            "type": "value",
                            "name": "time_period",
                            "operator": "<=",
                            "value": "24"
                        }
                    ]
                },
                {
                    "type": "criteria",
                    "logical_operator": "AT_LEAST",
                    "logical_operator_arguments": ["1"],
                    "values": [
                        {
                            "type": "symptom",
                            "name": "watery_stool"
                        },
                        {
                            "type": "symptom",
                            "name": "unformed_stool"
                        }
                    ]
                },
                {
                    "type": "criteria",
                    "logical_operator": "OR",
                    "values": [
                        {
                            "type": "symptom",
                            "name": "dehydration"
                        },
                        {
                            "type": "symptom",
                            "name": "decreased_skin_turgor"
                        },
                        {
                            "type": "symptom",
                            "name": "sunken_eyes"
                        },
                        {
                            "type": "value",
                            "name": "blood_pressure",
                            "operator": "<",
                            "value": "90/60"
                        }
                    ]
                }
            ]
        }

            responseDiv.dataset.rawResponse = JSON.stringify(hardCodedSyndrome, null, 2); // #response.data
            const formattedContent = syntaxHighlight(hardCodedSyndrome);
            responseDiv.innerHTML = `
                <button id="copyButton" onclick="copyToClipboard(this.parentElement.dataset.rawResponse)">
                    Copy
                </button>
                <pre>${formattedContent}</pre>
            `;
            responseDiv.style.display = 'block';
            responseDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } catch (error) {
            errorDiv.textContent = 'Error: ' + 
                (error.response?.data?.error || 'Something went wrong. Please try again.');
            errorDiv.style.display = 'block';
        } finally {
            submitBtn.disabled = false;
            loading.style.display = 'none';
        }
    }

    function clearEditor() {
        document.getElementById('editorInput').value = '';
        document.getElementById('editorResponse').style.display = 'none';
        document.getElementById('editorError').style.display = 'none';
    }
</script>
